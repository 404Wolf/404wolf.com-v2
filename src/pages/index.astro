---
import { getCollection } from "astro:content";
import ExtendedAbout from "../content/ExtendedAbout.mdx";
import BasicAbout from "../content/BasicAbout.mdx";
import BaseLayout from "../layouts/BaseLayout.astro";
import { Tile } from "../components/Tile.tsx";
import BasicPostCard from "../components/BasicPostCard.astro";
import simpleGit from "simple-git";
import { GITHUB_URL, SITE_URL } from "../consts";

const lastCommit = await simpleGit().log({ maxCount: 1 });
const lastCommitDate = lastCommit.latest?.date
	? new Date(lastCommit.latest.date)
	: null;
const lastCommitHash = lastCommit.latest?.hash;

const allPosts = await getCollection("posts");
const featuredPosts = allPosts
	.filter((post) => post.data.tags?.includes("featured"))
	.sort(
		(a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime(),
	)
	.slice(0, 6)
	.map((post) => {
		// Remove the "featured" tag since we are only showing featured posts anyway
		post.data.tags = post.data.tags.filter((tag) => tag !== "featured");
		return post;
	});
---

<BaseLayout>
  <BasicAbout slot="header-body" />

  <Fragment slot="head">
    <meta name="description" content="Wolf Mermelstein's personal website" />
    <meta name="author" content="Wolf Mermelstein" />
    
    <link rel="canonical" href={SITE_URL} />

    <meta property="og:type" content="website" />
    <meta property="og:url" content={SITE_URL}/>
    <meta property="og:title" content="Wolf Mermelstein Personal Website" />
    <meta property="og:description" content="Wolf Mermelstein's personal website" />
    <meta property="og:image" content="https://static.404wolf.com/profileMe.jpg" />
    <meta property="og:image:alt" content="Wolf Mermelstein profile photo" />

    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={SITE_URL} />
    <meta property="twitter:title" content="Wolf Mermelstein's Website" />
    <meta property="twitter:image" content="https://static.404wolf.com/profileMe.jpg" />
    <meta property="twitter:image:alt" content="Wolf Mermelstein profile photo" />
  </Fragment>

  <div class="flex flex-col sm:flex-row gap-7 sm:max-h-[50vh]">
    {
      featuredPosts.length > 0 && (
        <Tile
          client:load
          title="Featured Posts"
          innerClassName="overflow-y-scroll h-full"
          containerClassName="flex-1/3"
        >
          <div class="flex flex-col gap-6">
            {featuredPosts.map((post) => (
              <BasicPostCard
                path={`/posts/${post.id}/`}
                post={{
                  covers: post.data.covers,
                  title: post.data.title,
                  description: post.data.description,
                  date: post.data.date,
                  tags: post.data.tags,
                  type: post.data.type,
                }}
              />
            ))}
          </div>
        </Tile>
      )
    }

    <Tile
      client:load
      title="About"
      innerClassName="h-full overflow-y-scroll"
      containerClassName="flex-2/3"
    >
      <div class="[&_p]:mb-4">
        <ExtendedAbout />
      </div>
    </Tile>
  </div>

  {
    lastCommitDate && (
      <a
        class="hidden sm:block absolute bottom-0 -left-10 rotate-[20deg] bg-slate-300/30 hover:bg-slate-400/30 px-2 py-[2px] rounded-xl"
        href={`${GITHUB_URL}/commit/${lastCommitHash}`}
        target="_blank"
        rel="noopener noreferrer"
      >
        <p class="text-sm">
          Updated @ <span id="commit-date" data-date={lastCommitDate.toISOString()}>
            {lastCommitDate.toLocaleDateString("en-US", {
              month: "numeric",
              day: "numeric",
              year: "numeric",
            })}
          </span>
        </p>
      </a>
    )
  }
</BaseLayout>

<script>
  const commitDateElement = document.getElementById('commit-date');
  if (commitDateElement) {
    const isoDate = commitDateElement.getAttribute('data-date');
    if (isoDate) {
      const date = new Date(isoDate);
      commitDateElement.textContent = date.toLocaleDateString('en-US', {
        month: 'numeric',
        day: 'numeric',
        year: 'numeric',
      });
    }
  }
</script>
