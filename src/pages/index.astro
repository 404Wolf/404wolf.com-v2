---
import { getCollection } from "astro:content";
import ExtendedAbout from "../content/ExtendedAbout.mdx";
import BasicAbout from "../content/BasicAbout.mdx";
import BaseLayout from "../layouts/BaseLayout.astro";
import { Tile } from "../components/Tile.tsx";
import BasicPostCard from "../components/BasicPostCard.astro";
import simpleGit from "simple-git";

const lastCommit = await simpleGit().log({ maxCount: 1 });
const lastCommitDate = lastCommit.latest?.date
  ? new Date(lastCommit.latest.date)
  : null;

const allPosts = await getCollection("blog");
const featuredPosts = allPosts
  .filter((post) => post.data.tags?.includes("featured"))
  .slice(0, 6)
  .map((post) => {
    // Remove the "featured" tag since we are only showing featured posts anyway
    post.data.tags = post.data.tags.filter((tag) => tag !== "featured");
    return post;
  });
---

<BaseLayout title="Home">
  <BasicAbout slot="header-body" />

  <!-- Using flexbox for responsive layout -->
  <div class="flex flex-col sm:flex-row gap-7 sm:max-h-[50vh]">
    {
      featuredPosts.length > 0 && (
        <Tile
          client:load
          title="Featured Posts"
          innerClassName="overflow-y-scroll h-full"
          containerClassName="flex-1/3"
        >
          <div class="flex flex-col gap-6">
            {featuredPosts.map((post) => (
              <BasicPostCard
                path={`/posts/${post.id}/`}
                post={{
                  covers: post.data.covers,
                  title: post.data.title,
                  description: post.data.description,
                  date: post.data.date,
                  tags: post.data.tags,
                  type: post.data.type,
                }}
              />
            ))}
          </div>
        </Tile>
      )
    }

    <Tile
      client:load
      title="About"
      innerClassName="h-full overflow-y-scroll"
      containerClassName="flex-2/3"
    >
      <div class="[&_p]:mb-4">
        <ExtendedAbout />
      </div>
    </Tile>
  </div>

  {
    lastCommitDate && (
      <div class="hidden sm:block absolute bottom-0 -left-10 rotate-[20deg] bg-slate-300/30 px-2 py-[2px] rounded-xl">
        <p class="text-xs">
          Updated @{" "}
          {lastCommitDate.toLocaleDateString("en-US", {
            month: "numeric",
            day: "numeric",
            year: "numeric",
          })}
        </p>
      </div>
    )
  }
</BaseLayout>
